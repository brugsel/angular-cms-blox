"use strict";angular.module("angularCmsBlox",["ngResource","ngCookies","pascalprecht.translate","xeditable"]),angular.module("angularCmsBlox").directive("cmsLogin",[function(){return{restrict:"EA",replace:!0,scope:{},templateUrl:"authentication/login.html",controller:["$rootScope","$location","Loginservice","Authservice",function(a,b,c,d){this.login=function(){this.cmsLoginForm.$valid&&c.login(this.login.username,this.login.password).then(function(){b.path(d.getPath()?d.getPath():"/")},function(a){console.log([a.data.error])}),this.cmsLoginForm.$submitted=!0,a.$broadcast("cms-event-logged-in")},this.isLoggedIn=function(){return d.isLoggedIn()},this.isAuthorized=function(a){return d.isAuthorized(a)},this.logout=function(){d.logout(),a.$broadcast("cms-event-logged-out")}}],controllerAs:"ctrl",bindToController:!0}}]);var mockData={};mockData.contentType={"Content-type":"application/json"},mockData.wwwHome={_id:{$oid:"54cb4c34e4b0b3c7e59d03a0"},site:"www",part:"home",lang:"nl_NL",home:{title:"Mooie titel in het Nederlands!",subTitle:"Nou dat!"}},mockData.wwwArray=[mockData.wwwHome],angular.module("angularCmsBlox").directive("cmsText",[function(){return{restrict:"EA",replace:!1,scope:{key:"@cmsText"},templateUrl:"cms/cms-text.html",controller:"cmsTextController",controllerAs:"ctrl",bindToController:!0}}]).controller("cmsTextController",["$translate","$scope","Authservice",function(a,b,c){a(this.key).then(function(a){b.text=a}),this.save=function(){},this.isLoggedIn=function(){return c.isLoggedIn()}}]),angular.module("angularCmsBlox").run(["editableOptions",function(a){a.theme="bs3"}]).config(["$translateProvider",function(a){a.translations({home:{title:"Titel in het Nederlandse!"}})}]),angular.module("angularCmsBlox").factory("cmsService",["$resource","$q",function(a,b){var c=a("/api/example/cms"),d=function(a,d){var e=b.defer(),f={q:{site:a,page:d},f:{text:1}};return c.query(f,function(a){e.resolve(a)},function(a){e.reject(a.status)}),e.promise};return{getPageText:d}}]),angular.module("angularCmsBlox").factory("Authservice",["$cookieStore","ACCESS_LEVELS",function(a,b){var c,d=a.get("user"),e=function(a){return d?d.role>=a:!1},f=function(c){(!c.role||c.role<0)&&(c.role=b.pub),d=c,a.put("user",d)};return{isAuthorized:e,isLoggedIn:function(){return d?!0:!1},setUser:f,getUser:function(){return d},getToken:function(){return d?d.token:""},setToken:function(a){d&&(d.token=a)},logout:function(){a.remove("user"),d=null},getPath:function(){return c},setPath:function(a){c=a}}}]),angular.module("angularCmsBlox").constant("ACCESS_LEVELS",{pub:1,user:2,aso:4,dooner:8,root:16}).config(function(a){var b=function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.isAuthorized(d.user)&&!a.headers.Authorization&&-1===a.url.indexOf("/oauth/token")&&(console.log("Bearer headers added!"),a.headers.Authorization="Bearer "+c.getToken()),a},requestError:function(a){return a}}},c=function(a,b,c){return{response:function(a){return"/oauth/token"===a.config.url&&c.setToken(a.data.access_token),a},responseError:function(c){switch(c.status){case 401:"/oauth/token"!==c.config.url&&b.$broadcast("auth:loginRequired");break;case 403:b.$broadcast("auth:forbidden");break;case 404:b.$broadcast("page:notFound");break;case 500:b.$broadcast("server:error")}return a.reject(c)}}};a.interceptors.push(b),a.interceptors.push(c)}).run(function(a,b,c,d){a.$on("$stateChangeStart",function(a,e){e.accessLevel>d.pub&&(c.isAuthorized(e.accessLevel)||(c.isLoggedIn()?b.path("/"):(c.setPath(b.path()),b.path("/login"))))}),a.$on("auth:loginRequired",function(){c.setPath(b.path()),b.path("/login")})}),angular.module("angularCmsBlox").factory("Loginservice",["$http","$location","$q","Authservice","ACCESS_LEVELS",function(a,b,c,d,e){var f=function(f,g){var h=c.defer(),i=b.protocol()+"://"+b.host()+":"+b.port()+"/oauth/token",j={grant_type:"password",username:f,password:g};return a({method:"POST",url:i,transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:j,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){var b={role:e.user,username:f,token:a.access_token};d.setUser(b),h.resolve(a)})["catch"](function(a){h.reject(a)}),h.promise},g=function(){d.logoff()};return{login:f,logoff:g}}]);